---
title: "Day 11: æœ¬åœ°é–‹ç™¼ç’°å¢ƒçš„è³‡æ–™åº«ç®¡ç†å¯¦è¸ - ç”¨ DevSpace + Flyway æ‰“é€ å®Œç¾é–‹ç™¼é«”é©—"
tags: 2025éµäººè³½
date: 2025-07-20
---
ğŸ¯ å­¸ç¿’ç›®æ¨™
ä»Šå¤©æˆ‘å€‘è¦è§£æ±ºä¸€å€‹å¯¦éš›å•é¡Œï¼šå¦‚ä½•åœ¨ Kubernetes ç’°å¢ƒä¸­ï¼Œåƒä½¿ç”¨ Docker Compose ä¸€æ¨£ç°¡å–®åœ°ç®¡ç†è³‡æ–™åº«å’Œ Migrationï¼Ÿ

æƒ³åƒä¸€ä¸‹ï¼Œä½ ç¿’æ…£äº† docker-compose up ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™ï¼Œç¾åœ¨è¦è½‰åˆ° Kubernetesï¼Œæ˜¯ä¸æ˜¯è¦ºå¾—å¾ˆè¤‡é›œï¼Ÿåˆ¥æ“”å¿ƒï¼Œä»Šå¤©æˆ‘å€‘ç”¨ DevSpace + Flyway ä¾†è§£æ±ºé€™å€‹å•é¡Œï¼

ğŸ“š ä»Šå¤©ä½ æœƒå­¸åˆ°
ğŸ³ å¾ Docker Compose æ€ç¶­è½‰æ›åˆ° Kubernetes
ğŸš€ ä½¿ç”¨ DevSpace ç°¡åŒ–æœ¬åœ°é–‹ç™¼æµç¨‹
ğŸ—„ï¸ æ•´åˆ Flyway Migration åˆ°é–‹ç™¼å·¥ä½œæµ
ğŸ”„ å»ºç«‹å®Œæ•´çš„è³‡æ–™åº«ç®¡ç†è‡ªå‹•åŒ–
ğŸ› ï¸ è§£æ±ºå¸¸è¦‹é–‹ç™¼ç’°å¢ƒå•é¡Œ

ğŸ¤” å•é¡Œï¼šå¾ Docker Compose åˆ° Kubernetes çš„ç—›é»
Docker Compose çš„ç¾å¥½æ™‚å…‰
é‚„è¨˜å¾—ç”¨ Docker Compose é–‹ç™¼æ˜¯å¤šéº¼ç°¡å–®å—ï¼Ÿ

Docker compose é–‹ç™¼æµç¨‹
```yaml=
# docker-compose.yml - å‚³çµ±æœ¬åœ°é–‹ç™¼
version: '3.8'
services:
  # è³‡æ–™åº«æœå‹™
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - ./init-scripts:/docker-entrypoint-initdb.d  # ğŸ¯ è‡ªå‹•åŸ·è¡Œåˆå§‹åŒ–
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  
  # Flyway Migration
  flyway:
    image: flyway/flyway:8
    command: -url=jdbc:postgresql://postgres:5432/myapp -user=postgres -password=password migrate
    volumes:
      - ./migrations:/flyway/sql  # ğŸ¯ Migration è…³æœ¬
    depends_on:
      - postgres  # ğŸ¯ è‡ªå‹•ç­‰å¾…è³‡æ–™åº«
  
  # æ‡‰ç”¨ç¨‹å¼
  app:
    build: .
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/myapp
    ports:
      - "3000:3000"
    depends_on:
      - flyway  # ğŸ¯ ç¢ºä¿ Migration å®Œæˆ
    volumes:
      - .:/app  # ğŸ¯ ç†±é‡è¼‰é–‹ç™¼

volumes:
  postgres_data:
```

é–‹ç™¼æµç¨‹è¶…ç°¡å–®ï¼š
```bash
# ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™ï¼ˆåŒ…å«è³‡æ–™åº«åˆå§‹åŒ–å’Œ Migrationï¼‰
docker-compose up -d

# æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ
docker-compose logs -f

# é€²å…¥è³‡æ–™åº«æª¢æŸ¥
docker-compose exec postgres psql -U postgres -d myapp

# é‡æ–°åŸ·è¡Œ Migration
docker-compose restart flyway
```


# Day 9B: æœ¬åœ°é–‹ç™¼ç’°å¢ƒçš„æ•¸æ“šåº«ç®¡ç†å¯¦è¸

## ğŸ¯ å­¸ç¿’ç›®æ¨™

åœ¨ä¸Šä¸€ç¯‡å­¸æœƒ StatefulSet åŸºç¤æ¦‚å¿µå¾Œï¼Œä»Šå¤©æˆ‘å€‘è¦è§£æ±ºå¯¦éš›é–‹ç™¼ä¸­çš„å•é¡Œï¼šå¦‚ä½•åœ¨ Kubernetes ç’°å¢ƒä¸­å»ºç«‹é¡ä¼¼ Docker Compose çš„æœ¬åœ°é–‹ç™¼é«”é©—ï¼ŒåŒ…æ‹¬æ•¸æ“šåº«åˆå§‹åŒ–ã€Schema Migrationã€ä»¥åŠèˆ‡æ‡‰ç”¨ç¨‹å¼çš„æ•´åˆæ¸¬è©¦ã€‚

### ğŸ“š å­¸ç¿’é‡é»
- ä½¿ç”¨ DevSpace ç°¡åŒ–æœ¬åœ°é–‹ç™¼æµç¨‹
- æ•´åˆ SQL åˆå§‹åŒ–è…³æœ¬åˆ° StatefulSet
- å¯¦ç¾ Flyway Migration è‡ªå‹•åŒ–
- å»ºç«‹å®Œæ•´çš„æœ¬åœ°é–‹ç™¼å·¥ä½œæµ
- è§£æ±ºå¸¸è¦‹çš„é–‹ç™¼ç’°å¢ƒå•é¡Œ

---

## ğŸ³ å¾ Docker Compose åˆ° Kubernetes

### å‚³çµ± Docker Compose é–‹ç™¼æµç¨‹

```yaml
# docker-compose.yml - å‚³çµ±æœ¬åœ°é–‹ç™¼
version: '3.8'
services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - ./init-scripts:/docker-entrypoint-initdb.d  # åˆå§‹åŒ–è…³æœ¬
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  
  flyway:
    image: flyway/flyway:8
    command: -url=jdbc:postgresql://postgres:5432/myapp -user=postgres -password=password migrate
    volumes:
      - ./migrations:/flyway/sql  # Migration è…³æœ¬
    depends_on:
      - postgres
  
  app:
    build: .
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/myapp
    ports:
      - "3000:3000"
    depends_on:
      - flyway
    volumes:
      - .:/app  # ç†±é‡è¼‰

volumes:
  postgres_data:
```

**é–‹ç™¼æµç¨‹**ï¼š
```bash
# ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™
docker-compose up -d

# æŸ¥çœ‹æ—¥èªŒ
docker-compose logs -f

# é€²å…¥æ•¸æ“šåº«
docker-compose exec postgres psql -U postgres -d myapp
```


Kubernetes çš„æŒ‘æˆ°
è½‰åˆ° Kubernetes å¾Œï¼ŒåŒæ¨£çš„äº‹æƒ…è®Šå¾—è¤‡é›œï¼š

```mermaid
graph TB
    subgraph "ğŸ³ Docker Compose çš„ç¾å¥½"
        DC1[ğŸš€ ä¸€éµå•Ÿå‹•]
        DC2[ğŸ”— è‡ªå‹•ä¾è³´ç®¡ç†]
        DC3[ğŸ“ ç°¡å–®æª”æ¡ˆæ›è¼‰]
        DC4[ğŸ”¥ ç†±é‡è¼‰æ”¯æŒ]
        DC5[ğŸ“Š çµ±ä¸€æ—¥èªŒæŸ¥çœ‹]
        DC6[ğŸ—„ï¸ è‡ªå‹• Migration]
    end
    
    subgraph "â˜¸ï¸ Kubernetes çš„ç¾å¯¦"
        K1[ğŸ“„ å¤šå€‹ YAML æª”æ¡ˆ]
        K2[ğŸ¤¯ è¤‡é›œä¾è³´é—œä¿‚]
        K3[âš™ï¸ ConfigMap/Secret ç®¡ç†]
        K4[ğŸ”Œ æ‰‹å‹•ç«¯å£è½‰ç™¼]
        K5[ğŸ” åˆ†æ•£çš„æ—¥èªŒæŸ¥çœ‹]
        K6[ğŸ› ï¸ æ‰‹å‹• Migration åŸ·è¡Œ]
    end
    
    DC1 -.->|è®Šæˆ| K1
    DC2 -.->|è®Šæˆ| K2
    DC3 -.->|è®Šæˆ| K3
    DC4 -.->|è®Šæˆ| K4
    DC5 -.->|è®Šæˆ| K5
    DC6 -.->|è®Šæˆ| K6
    
    style DC1 fill:#c8e6c9
    style DC2 fill:#c8e6c9
    style DC3 fill:#c8e6c9
    style DC4 fill:#c8e6c9
    style DC5 fill:#c8e6c9
    style DC6 fill:#c8e6c9
    style K1 fill:#ffcdd2
    style K2 fill:#ffcdd2
    style K3 fill:#ffcdd2
    style K4 fill:#ffcdd2
    style K5 fill:#ffcdd2
    style K6 fill:#ffcdd2
```
å•é¡Œç¸½çµï¼š

ğŸ¤¯ éœ€è¦å¯«å¾ˆå¤š YAML æª”æ¡ˆ
ğŸ”— æ‰‹å‹•ç®¡ç†æœå‹™ä¾è³´é—œä¿‚
ğŸ› ï¸ Migration éœ€è¦æ‰‹å‹•åŸ·è¡Œ
ğŸ“Š ç„¡æ³•åƒ Docker Compose ä¸€æ¨£æŸ¥çœ‹çµ±ä¸€æ—¥èªŒ
ğŸ”¥ ç†±é‡è¼‰é–‹ç™¼é«”é©—å·®

ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼šDevSpace + Flyway
DevSpace æ˜¯ä»€éº¼ï¼Ÿ
DevSpace å°±åƒæ˜¯ Kubernetes ç‰ˆçš„ Docker Composeï¼


```mermaid
graph LR
    subgraph "ğŸ‘¨â€ğŸ’» é–‹ç™¼è€…é«”é©—"
        DEV[é–‹ç™¼è€…]
        CMD[ä¸€å€‹å‘½ä»¤]
    end
    
    subgraph "ğŸš€ DevSpace é­”æ³•"
        DS[DevSpace CLI]
        CONFIG[devspace.yaml]
    end
    
    subgraph "â˜¸ï¸ Kubernetes è¤‡é›œæ€§"
        K8S[Kubernetes Cluster]
        DEPLOY[è‡ªå‹•éƒ¨ç½²]
        SYNC[æª”æ¡ˆåŒæ­¥]
        PF[ç«¯å£è½‰ç™¼]
        LOGS[æ—¥èªŒèšåˆ]
        FLYWAY[Flyway Migration]
    end
    
    DEV --> CMD
    CMD --> DS
    DS --> CONFIG
    CONFIG --> DEPLOY
    CONFIG --> SYNC
    CONFIG --> PF
    CONFIG --> LOGS
    CONFIG --> FLYWAY
    
    DEPLOY --> K8S
    SYNC --> K8S
    PF --> K8S
    LOGS --> K8S
    FLYWAY --> K8S
    
    style DEV fill:#e3f2fd
    style DS fill:#c8e6c9
    style CONFIG fill:#fff3e0
    style K8S fill:#f3e5f5
```


å°ˆæ¡ˆçµæ§‹è¨­è¨ˆ
è®“æˆ‘å€‘å»ºç«‹ä¸€å€‹å®Œæ•´çš„å°ˆæ¡ˆçµæ§‹ï¼š
```
```bash
# å»ºç«‹å°ˆæ¡ˆç›®éŒ„
mkdir myapp-k8s-dev
cd myapp-k8s-dev

# å®Œæ•´å°ˆæ¡ˆçµæ§‹
myapp-k8s-dev/
â”œâ”€â”€ devspace.yaml           # ğŸš€ DevSpace é…ç½®ï¼ˆé¡ä¼¼ docker-compose.ymlï¼‰
â”œâ”€â”€ k8s/                    # â˜¸ï¸ Kubernetes é…ç½®
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ statefulset.yaml    # è³‡æ–™åº«ä¸»é«”
â”‚   â”‚   â”œâ”€â”€ service.yaml        # è³‡æ–™åº«æœå‹™
â”‚   â”‚   â””â”€â”€ configmap.yaml      # åˆå§‹åŒ–è…³æœ¬
â”‚   â”œâ”€â”€ migration/
â”‚   â”‚   â””â”€â”€ job.yaml            # Flyway Migration Job
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ deployment.yaml     # æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²
â”‚       â””â”€â”€ service.yaml        # æ‡‰ç”¨ç¨‹å¼æœå‹™
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ init-scripts/       # ğŸ—„ï¸ è³‡æ–™åº«åˆå§‹åŒ–è…³æœ¬
â”‚   â”‚   â”œâ”€â”€ 01-init-db.sql
â”‚   â”‚   â””â”€â”€ 02-seed-data.sql
â”‚   â””â”€â”€ migrations/         # ğŸ”„ Flyway Migration è…³æœ¬
â”‚       â”œâ”€â”€ V1__Create_users_table.sql
â”‚       â”œâ”€â”€ V2__Create_posts_table.sql
â”‚       â””â”€â”€ V3__Add_indexes.sql
â”œâ”€â”€ app/                    # ğŸ“± æ‡‰ç”¨ç¨‹å¼ä»£ç¢¼
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â””â”€â”€ scripts/                # ğŸ› ï¸ è¼”åŠ©è…³æœ¬
    â”œâ”€â”€ setup-dev.sh
    â””â”€â”€ reset-db.sh
```

**å°æ¯” Docker Compose**ï¼š
- `devspace.yaml` = `docker-compose.yml`
- `k8s/` = æœå‹™å®šç¾©ï¼ˆä½†æ›´è©³ç´°ï¼‰
- `database/` = å’Œ Docker Compose ä¸€æ¨£çš„è³‡æ–™åº«æª”æ¡ˆ
- `scripts/` = é–‹ç™¼è¼”åŠ©å·¥å…·

ğŸ—„ï¸ æ­¥é©Ÿä¸€ï¼šè¨­å®šè³‡æ–™åº«èˆ‡åˆå§‹åŒ–
1. è³‡æ–™åº«åˆå§‹åŒ–è…³æœ¬
å…ˆæº–å‚™æˆ‘å€‘çš„è³‡æ–™åº«åˆå§‹åŒ–è…³æœ¬ï¼š

```sql
-- database/init-scripts/01-init-db.sql
-- ğŸ¯ å»ºç«‹æ‡‰ç”¨è³‡æ–™åº«å’Œç”¨æˆ¶ï¼ˆé¡ä¼¼ Docker Compose çš„ç’°å¢ƒè®Šæ•¸æ•ˆæœï¼‰

-- å»ºç«‹æ‡‰ç”¨è³‡æ–™åº«
CREATE DATABASE myapp;

-- å»ºç«‹æ‡‰ç”¨ç”¨æˆ¶
CREATE USER appuser WITH ENCRYPTED PASSWORD 'apppassword';
GRANT ALL PRIVILEGES ON DATABASE myapp TO appuser;

-- é€£æ¥åˆ°æ‡‰ç”¨è³‡æ–™åº«
\c myapp;

-- å»ºç«‹æ‡‰ç”¨ schema
CREATE SCHEMA IF NOT EXISTS app;
GRANT ALL ON SCHEMA app TO appuser;

-- è¨­å®šæœå°‹è·¯å¾‘
ALTER USER appuser SET search_path = app, public;

-- å®‰è£å¿…è¦æ“´å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

SELECT 'Database initialized successfully' AS status;
```

```sql
-- database/init-scripts/02-seed-data.sql
-- ğŸŒ± æ’å…¥é–‹ç™¼ç”¨æ¸¬è©¦è³‡æ–™

\c myapp;
SET search_path = app, public;

-- å»ºç«‹åŸºæœ¬ä½¿ç”¨è€…è¡¨ï¼ˆFlyway ä¹‹å‰çš„åŸºç¤è³‡æ–™ï¼‰
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æ¸¬è©¦ä½¿ç”¨è€…
INSERT INTO users (username, email, password_hash) VALUES
    ('admin', 'admin@example.com', crypt('admin123', gen_salt('bf'))),
    ('developer', 'dev@example.com', crypt('dev123', gen_salt('bf'))),
    ('tester', 'test@example.com', crypt('test123', gen_salt('bf')))
ON CONFLICT (username) DO NOTHING;

SELECT 'Seed data inserted successfully' AS status;
```

2. ConfigMap é…ç½®
å°‡åˆå§‹åŒ–è…³æœ¬åŒ…è£æˆ ConfigMapï¼š
```yaml
# k8s/database/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  labels:
    app: postgres
data:
  # ğŸ¯ åˆå§‹åŒ–è…³æœ¬ï¼ˆæœƒè‡ªå‹•åŸ·è¡Œï¼Œé¡ä¼¼ Docker Compose çš„ /docker-entrypoint-initdb.dï¼‰
  01-init-db.sql: |
    -- å»ºç«‹æ‡‰ç”¨è³‡æ–™åº«
    CREATE DATABASE myapp;
    
    -- å»ºç«‹ç”¨æˆ¶
    CREATE USER appuser WITH ENCRYPTED PASSWORD 'apppassword';
    GRANT ALL PRIVILEGES ON DATABASE myapp TO appuser;
    
    -- é€£æ¥åˆ°æ‡‰ç”¨è³‡æ–™åº«
    \c myapp;
    
    -- å»ºç«‹ schema
    CREATE SCHEMA IF NOT EXISTS app;
    GRANT ALL ON SCHEMA app TO appuser;
    
    -- è¨­å®šæœå°‹è·¯å¾‘
    ALTER USER appuser SET search_path = app, public;
    
    -- å»ºç«‹æ“´å±•
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";
    
    SELECT 'Database initialized successfully' AS status;

  02-seed-data.sql: |
    -- é€£æ¥åˆ°æ‡‰ç”¨è³‡æ–™åº«
    \c myapp;
    SET search_path = app, public;
    
    -- å»ºç«‹åŸºæœ¬è¡¨æ ¼
    CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- æ’å…¥æ¸¬è©¦è³‡æ–™
    INSERT INTO users (username, email, password_hash) VALUES
        ('admin', 'admin@example.com', crypt('admin123', gen_salt('bf'))),
        ('developer', 'dev@example.com', crypt('dev123', gen_salt('bf'))),
        ('tester', 'test@example.com', crypt('test123', gen_salt('bf')))
    ON CONFLICT (username) DO NOTHING;
    
    SELECT 'Seed data inserted successfully' AS status;

---
# Secret ç”¨æ–¼æ•æ„Ÿè³‡æ–™
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
data:
  # echo -n "password" | base64
  POSTGRES_PASSWORD: cGFzc3dvcmQ=
  # echo -n "apppassword" | base64  
  APP_DB_PASSWORD: YXBwcGFzc3dvcmQ=
  # echo -n "postgresql://appuser:apppassword@postgres-service:5432/myapp" | base64
  DATABASE_URL: cG9zdGdyZXNxbDovL2FwcHVzZXI6YXBwcGFzc3dvcmRAcG9zdGdyZXMtc2VydmljZTo1NDMyL215YXBw
```

3. StatefulSet é…ç½®

```yaml
# k8s/database/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  labels:
    app: postgres
spec:
  serviceName: postgres-service
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:14-alpine
        ports:
        - containerPort: 5432
          name: postgres
        env:
        # ğŸ¯ åŸºæœ¬è³‡æ–™åº«è¨­å®šï¼ˆé¡ä¼¼ Docker Compose ç’°å¢ƒè®Šæ•¸ï¼‰
        - name: POSTGRES_DB
          value: postgres
        - name: POSTGRES_USER  
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        # ğŸ¯ é–‹ç™¼ç’°å¢ƒè¨­å®š
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
        
        volumeMounts:
        # ğŸ—„ï¸ è³‡æ–™æŒä¹…åŒ–
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        # ğŸ¯ åˆå§‹åŒ–è…³æœ¬æ›è¼‰ï¼ˆé¡ä¼¼ Docker Compose çš„ volumesï¼‰
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        
        # ğŸ¥ å¥åº·æª¢æŸ¥
        livenessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          exec:
            command:
            - pg_isready
            - -U
            - postgres
          initialDelaySeconds: 5
          periodSeconds: 5
      
      volumes:
      # ğŸ¯ æ›è¼‰åˆå§‹åŒ–è…³æœ¬
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
  
  # ğŸ—„ï¸ æŒä¹…åŒ–å„²å­˜
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 1Gi

---
# Service ç”¨æ–¼å…§éƒ¨é€šè¨Š
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
  labels:
    app: postgres
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  type: ClusterIP
```

ğŸ”„ æ­¥é©ŸäºŒï¼šè¨­å®š Flyway Migration
1. Migration è…³æœ¬æº–å‚™

```sql
-- database/migrations/V1__Create_users_table.sql
-- ğŸ¯ å»ºç«‹ä½¿ç”¨è€…è¡¨æ ¼çš„æ­£å¼ç‰ˆæœ¬ï¼ˆå–ä»£åˆå§‹åŒ–è…³æœ¬ä¸­çš„è‡¨æ™‚ç‰ˆæœ¬ï¼‰

-- åˆªé™¤è‡¨æ™‚è¡¨æ ¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP TABLE IF EXISTS users;

-- å»ºç«‹æ­£å¼çš„ä½¿ç”¨è€…è¡¨æ ¼
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    avatar_url VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(is_active);

-- æ’å…¥åˆå§‹ç®¡ç†å“¡
INSERT INTO users (username, email, password_hash, first_name, last_name, is_active, email_verified) 
VALUES 
    ('admin', 'admin@example.com', crypt('admin123', gen_salt('bf')), 'Admin', 'User', true, true),
    ('developer', 'dev@example.com', crypt('dev123', gen_salt('bf')), 'Developer', 'User', true, true);
```

```sql
-- database/migrations/V2__Create_posts_table.sql
-- ğŸ¯ å»ºç«‹æ–‡ç« è¡¨æ ¼

CREATE TABLE posts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    excerpt VARCHAR(500),
    slug VARCHAR(200) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived')),
    featured_image_url VARCHAR(255),
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_status ON posts(status);
CREATE INDEX idx_posts_published_at ON posts(published_at);
CREATE INDEX idx_posts_slug ON posts(slug);

-- æ’å…¥ç¯„ä¾‹æ–‡ç« 
INSERT INTO posts (user_id, title, content, excerpt, slug, status, published_at)
SELECT 
    u.id,
    'Welcome to Our Platform',
    'This is your first post. You can edit or delete it, then start writing!',
    'Welcome post for new users',
    'welcome-to-our-platform',
    'published',
    CURRENT_TIMESTAMP
FROM users u WHERE u.username = 'admin';
```

```sql
-- database/migrations/V3__Add_user_profiles.sql
-- ğŸ¯ æ–°å¢ä½¿ç”¨è€…å€‹äººæª”æ¡ˆåŠŸèƒ½

CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    bio TEXT,
    location VARCHAR(100),
    website VARCHAR(255),
    twitter_handle VARCHAR(50),
    github_username VARCHAR(50),
    linkedin_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç¢ºä¿æ¯å€‹ä½¿ç”¨è€…åªæœ‰ä¸€å€‹æª”æ¡ˆ
CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

-- ç‚ºç¾æœ‰ä½¿ç”¨è€…å»ºç«‹ç©ºæª”æ¡ˆ
INSERT INTO user_profiles (user_id, bio)
SELECT id, 'Hello! I am new to this platform.' 
FROM users 
WHERE NOT EXISTS (
    SELECT 1 FROM user_profiles WHERE user_profiles.user_id = users.id
);
```

2. Flyway Migration Job

```
```yaml
# k8s/migration/configmap.yaml - Migration è…³æœ¬
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-migrations
  labels:
    app: flyway
data:
  V1__Create_users_table.sql: |
    -- åˆªé™¤è‡¨æ™‚è¡¨æ ¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    DROP TABLE IF EXISTS users;
    
    -- å»ºç«‹æ­£å¼çš„ä½¿ç”¨è€…è¡¨æ ¼
    CREATE TABLE users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        first_name VARCHAR(50),
        last_name VARCHAR(50),
        avatar_url VARCHAR(255),
        is_active BOOLEAN DEFAULT true,
        email_verified BOOLEAN DEFAULT false,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- å»ºç«‹ç´¢å¼•
    CREATE INDEX idx_users_username ON users(username);
    CREATE INDEX idx_users_email ON users(email);
    CREATE INDEX idx_users_active ON users(is_active);
    
    -- æ’å…¥åˆå§‹ç®¡ç†å“¡
    INSERT INTO users (username, email, password_hash, first_name, last_name, is_active, email_verified) 
    VALUES 
        ('admin', 'admin@example.com', crypt('admin123', gen_salt('bf')), 'Admin', 'User', true, true),
        ('developer', 'dev@example.com', crypt('dev123', gen_salt('bf')), 'Developer', 'User', true, true);

  V2__Create_posts_table.sql: |
    CREATE TABLE posts (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        title VARCHAR(200) NOT NULL,
        content TEXT,
        excerpt VARCHAR(500),
        slug VARCHAR(200) UNIQUE NOT NULL,
        status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived')),
        featured_image_url VARCHAR(255),
        published_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- å»ºç«‹ç´¢å¼•
    CREATE INDEX idx_posts_user_id ON posts(user_id);
    CREATE INDEX idx_posts_status ON posts(status);
    CREATE INDEX idx_posts_published_at ON posts(published_at);
    CREATE INDEX idx_posts_slug ON posts(slug);
    
    -- æ’å…¥ç¯„ä¾‹æ–‡ç« 
    INSERT INTO posts (user_id, title, content, excerpt, slug, status, published_at)
    SELECT 
        u.id,
        'Welcome to Our Platform',
        'This is your first post. You can edit or delete it, then start writing!',
        'Welcome post for new users',
        'welcome-to-our-platform',
        'published',
        CURRENT_TIMESTAMP
    FROM users u WHERE u.username = 'admin';

  V3__Add_user_profiles.sql: |
    CREATE TABLE user_profiles (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        bio TEXT,
        location VARCHAR(100),
        website VARCHAR(255),
        twitter_handle VARCHAR(50),
        github_username VARCHAR(50),
        linkedin_url VARCHAR(255),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- ç¢ºä¿æ¯å€‹ä½¿ç”¨è€…åªæœ‰ä¸€å€‹æª”æ¡ˆ
    CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
    
    -- ç‚ºç¾æœ‰ä½¿ç”¨è€…å»ºç«‹ç©ºæª”æ¡ˆ
    INSERT INTO user_profiles (user_id, bio)
    SELECT id, 'Hello! I am new to this platform.' 
    FROM users 
    WHERE NOT EXISTS (
        SELECT 1 FROM user_profiles WHERE user_profiles.user_id = users.id
    );

---
# k8s/migration/job.yaml - Flyway Migration Job
apiVersion: batch/v1
kind: Job
metadata:
  name: flyway-migration
  labels:
    app: flyway
spec:
  template:
    metadata:
      labels:
        app: flyway
    spec:
      restartPolicy: OnFailure
      
      # ğŸ¯ ç­‰å¾…è³‡æ–™åº«å°±ç·’çš„ Init Container
      initContainers:
      - name: wait-for-db
        image: postgres:14-alpine
        command: ['/bin/sh', '-c']
        args:
        - |
          echo "ğŸ” ç­‰å¾…è³‡æ–™åº«å°±ç·’..."
          until pg_isready -h postgres-service -p 5432 -U postgres; do
            echo "è³‡æ–™åº«æœªå°±ç·’ï¼Œç­‰å¾… 3 ç§’..."
            sleep 3
          done
          
          echo "ğŸ” æ¸¬è©¦æ‡‰ç”¨ä½¿ç”¨è€…é€£ç·š..."
          until PGPASSWORD=$APP_DB_PASSWORD psql -h postgres-service -p 5432 -U appuser -d myapp -c "SELECT 1;" > /dev/null 2>&1; do
            echo "æ‡‰ç”¨ä½¿ç”¨è€…é€£ç·šå¤±æ•—ï¼Œç­‰å¾… 3 ç§’..."
            sleep 3
          done
          
          echo "âœ… è³‡æ–™åº«å®Œå…¨å°±ç·’ï¼"
        env:
        - name: APP_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: APP_DB_PASSWORD
      
      containers:
      - name: flyway
        image: flyway/flyway:8-alpine
        command: ['/bin/sh', '-c']
        args:
        - |
          echo "ğŸš€ é–‹å§‹ Flyway Migration..."
          
          # é¡¯ç¤ºç›®å‰ç‹€æ…‹
          echo "ğŸ“Š Migration ç‹€æ…‹ï¼ˆåŸ·è¡Œå‰ï¼‰ï¼š"
          flyway \
            -url=jdbc:postgresql://postgres-service:5432/myapp \
            -user=appuser \
            -password=$FLYWAY_PASSWORD \
            -locations=filesystem:/flyway/sql \
            -schemas=app \
            info || echo "é¦–æ¬¡åŸ·è¡Œï¼Œç„¡æ­·å²è¨˜éŒ„"
          
          # åŸ·è¡Œ Migration
          flyway \
            -url=jdbc:postgresql://postgres-service:5432/myapp \
            -user=appuser \
            -password=$FLYWAY_PASSWORD \
            -locations=filesystem:/flyway/sql \
            -schemas=app \
            -baselineOnMigrate=true \
            -validateOnMigrate=true \
            migrate
          
          # é¡¯ç¤ºåŸ·è¡Œå¾Œç‹€æ…‹
          echo "ğŸ“Š Migration ç‹€æ…‹ï¼ˆåŸ·è¡Œå¾Œï¼‰ï¼š"
          flyway \
            -url=jdbc:postgresql://postgres-service:5432/myapp \
            -user=appuser \
            -password=$FLYWAY_PASSWORD \
            -locations=filesystem:/flyway/sql \
            -schemas=app \
            info
          
          echo "âœ… Flyway Migration å®Œæˆï¼"
        
        env:
        - name: FLYWAY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: APP_DB_PASSWORD
        
        volumeMounts:
        - name: flyway-migrations
          mountPath: /flyway/sql
      
      volumes:
      - name: flyway-migrations
        configMap:
          name: flyway-migrations
```
ğŸš€ æ­¥é©Ÿä¸‰ï¼šDevSpace é…ç½® - æ‰“é€  Docker Compose èˆ¬çš„é«”é©—
DevSpace æ ¸å¿ƒé…ç½®
é€™æ˜¯é—œéµï¼DevSpace è®“æˆ‘å€‘åƒä½¿ç”¨ Docker Compose ä¸€æ¨£ç°¡å–®ï¼š

```yaml
# devspace.yaml - ğŸ¯ é€™å°±æ˜¯æˆ‘å€‘çš„ "docker-compose.yml"
version: v2beta1
name: myapp-dev

# ğŸ¯ é¡ä¼¼ Docker Compose çš„ services
deployments:
  # è³‡æ–™åº«éƒ¨ç½²
  database:
    kubectl:
      manifests:
      - k8s/database/configmap.yaml
      - k8s/database/statefulset.yaml
    
  # Migration éƒ¨ç½²  
  migration:
    kubectl:
      manifests:
      - k8s/migration/configmap.yaml
      - k8s/migration/job.yaml
    # ğŸ¯ é¡ä¼¼ Docker Compose çš„ depends_on
    dependsOn:
    - database
    
  # æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²
  app:
    kubectl:
      manifests:
      - k8s/app/deployment.yaml
      - k8s/app/service.yaml
    dependsOn:
    - migration  # ç¢ºä¿ Migration å®Œæˆå¾Œæ‰å•Ÿå‹•æ‡‰ç”¨

# ğŸ¯ é¡ä¼¼ Docker Compose çš„ ports
dev:
  ports:
  - imageSelector: postgres:14-alpine
    forward:
    - port: 5432
      remotePort: 5432
  - imageSelector: myapp:latest  
    forward:
    - port: 3000
      remotePort: 3000
  
  # ğŸ¯ é¡ä¼¼ Docker Compose çš„ volumesï¼ˆç†±é‡è¼‰ï¼‰
  sync:
  - imageSelector: myapp:latest
    localSubPath: ./app
    containerPath: /app
    excludePaths:
    - node_modules/
    - .git/
    
  # ğŸ¯ é¡ä¼¼ Docker Compose logs -f
  logs:
    showLast: 50
    sync: true

# ğŸ› ï¸ è‡ªè¨‚æŒ‡ä»¤ï¼ˆé¡ä¼¼ Docker Compose çš„ä¾¿åˆ©æŒ‡ä»¤ï¼‰
commands:
  # æŸ¥çœ‹è³‡æ–™åº«
  - name: db
    command: |
      echo "ğŸ—„ï¸ é€£æ¥åˆ°è³‡æ–™åº«..."
      kubectl exec -it statefulset/postgres -- psql -U appuser -d myapp
  
  # é‡æ–°åŸ·è¡Œ Migration
  - name: migrate
    command: |
      echo "ğŸ”„ é‡æ–°åŸ·è¡Œ Migration..."
      kubectl delete job flyway-migration --ignore-not-found=true
      kubectl apply -f k8s/migration/job.yaml
      kubectl wait --for=condition=complete job/flyway-migration --timeout=300s
      kubectl logs job/flyway-migration
  
  # æŸ¥çœ‹ Migration ç‹€æ…‹
  - name: migration-status
    command: |
      echo "ğŸ“Š æª¢æŸ¥ Migration ç‹€æ…‹..."
      kubectl exec statefulset/postgres -- psql -U appuser -d myapp -c "
      SELECT installed_rank, version, description, installed_on, success 
      FROM app.flyway_schema_history 
      ORDER BY installed_rank;"
  
  # é‡ç½®è³‡æ–™åº«ï¼ˆé–‹ç™¼ç”¨ï¼‰
  - name: reset-db
    command: |
      echo "âš ï¸  é‡ç½®è³‡æ–™åº«ï¼ˆé€™æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼‰"
      read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ (y/N): " confirm
      if [ "$confirm" = "y" ]; then
        echo "ğŸ—‘ï¸ åˆªé™¤è³‡æ–™åº«..."
        kubectl exec statefulset/postgres -- psql -U postgres -c "DROP DATABASE IF EXISTS myapp;"
        kubectl exec statefulset/postgres -- psql -U postgres -c "CREATE DATABASE myapp;"
        kubectl exec statefulset/postgres -- psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE myapp TO appuser;"
        
        echo "ğŸ”„ é‡æ–°åŸ·è¡Œåˆå§‹åŒ–..."
        kubectl rollout restart statefulset/postgres
        kubectl rollout status statefulset/postgres
        
        echo "ğŸ”„ é‡æ–°åŸ·è¡Œ Migration..."
        devspace run migrate
        
        echo "âœ… è³‡æ–™åº«é‡ç½®å®Œæˆï¼"
      else
        echo "âŒ å–æ¶ˆæ“ä½œ"
      fi
  
  # æŸ¥çœ‹æ‰€æœ‰æœå‹™ç‹€æ…‹
  - name: status
    command: |
      echo "ğŸ“Š æœå‹™ç‹€æ…‹æ¦‚è¦½ï¼š"
      echo "===================="
      echo "ğŸ—„ï¸ è³‡æ–™åº«ï¼š"
      kubectl get statefulset postgres -o wide
      echo ""
      echo "ğŸ”„ Migration Jobï¼š"
      kubectl get job flyway-migration -o wide 2>/dev/null || echo "Migration job not found"
      echo ""
      echo "ğŸ“± æ‡‰ç”¨ç¨‹å¼ï¼š"
      kubectl get deployment myapp -o wide 2>/dev/null || echo "App deployment not found"
      echo ""
      echo "ğŸŒ æœå‹™ï¼š"
      kubectl get services

# ğŸ¯ é–‹ç™¼ç’°å¢ƒè®Šæ•¸ï¼ˆé¡ä¼¼ Docker Compose çš„ environmentï¼‰
vars:
  DB_HOST: postgres-service
  DB_PORT: "5432"
  DB_NAME: myapp
  DB_USER: appuser
```


æ‡‰ç”¨ç¨‹å¼é…ç½®
```yaml
# k8s/app/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  labels:
    app: myapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      # ğŸ¯ ç­‰å¾…è³‡æ–™åº«å’Œ Migration å®Œæˆçš„ Init Container
      initContainers:
      - name: wait-for-migration
        image: postgres:14-alpine
        command: ['/bin/sh', '-c']
        args:
        - |
          echo "ğŸ” ç­‰å¾… Migration å®Œæˆ..."
          
          # ç­‰å¾…è³‡æ–™åº«å¯ç”¨
          until pg_isready -h postgres-service -p 5432 -U postgres; do
            echo "ç­‰å¾…è³‡æ–™åº«..."
            sleep 3
          done
          
          # æª¢æŸ¥ Flyway schema history è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆè¡¨ç¤º Migration å·²åŸ·è¡Œï¼‰
          until PGPASSWORD=$APP_DB_PASSWORD psql -h postgres-service -p 5432 -U appuser -d myapp -c "SELECT 1 FROM app.flyway_schema_history LIMIT 1;" > /dev/null 2>&1; do
            echo "ç­‰å¾… Migration å®Œæˆ..."
            sleep 5
          done
          
          echo "âœ… Migration å·²å®Œæˆï¼Œæ‡‰ç”¨ç¨‹å¼å¯ä»¥å•Ÿå‹•ï¼"
        env:
        - name: APP_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: APP_DB_PASSWORD
      
      containers:
      - name: app
        image: myapp:latest
        ports:
        - containerPort: 3000
        env:
        # ğŸ¯ è³‡æ–™åº«é€£ç·šè¨­å®š
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: DATABASE_URL
        - name: NODE_ENV
          value: development
        - name: PORT
          value: "3000"
        
        # ğŸ¥ å¥åº·æª¢æŸ¥
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
        
        # ğŸ¯ é–‹ç™¼ç’°å¢ƒè³‡æºé™åˆ¶
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
# k8s/app/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
  labels:
    app: myapp
spec:
  selector:
    app: myapp
  ports:
  - port: 3000
    targetPort: 3000
    name: http
  type: ClusterIP
```

ğŸ® æ­¥é©Ÿå››ï¼šå¯¦éš›æ“ä½œ - åƒ Docker Compose ä¸€æ¨£ç°¡å–®ï¼
å®‰è£ DevSpace

```bash
# ğŸš€ å®‰è£ DevSpaceï¼ˆé¡ä¼¼å®‰è£ Docker Composeï¼‰

# macOS
brew install devspace

# Linux
curl -s -L "https://github.com/loft-sh/devspace/releases/latest" | sed -nE 's!.*"([^"]*devspace-linux-amd64)".*!https://github.com\1!p' | xargs -n 1 curl -L -o devspace && chmod +x devspace && sudo mv devspace /usr/local/bin

# Windows
# ä¸‹è¼‰ devspace.exe ä¸¦åŠ å…¥ PATH

# é©—è­‰å®‰è£
devspace --version
```

```bash
# ğŸ¯ åˆå§‹åŒ–å°ˆæ¡ˆï¼ˆé¡ä¼¼ docker-compose initï¼‰
cd myapp-k8s-dev

# DevSpace æœƒè‡ªå‹•åµæ¸¬ Kubernetes context
devspace use context  # é¸æ“‡ä½ çš„ K8s clusterï¼ˆå¦‚ minikube, kind, etc.ï¼‰

# åˆå§‹åŒ– DevSpace é…ç½®
devspace init
```



ä¸€éµå•Ÿå‹•é–‹ç™¼ç’°å¢ƒ

```bash
# ğŸš€ ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™ï¼ˆå°±åƒ docker-compose upï¼‰
devspace dev

# ä½ æœƒçœ‹åˆ°é¡ä¼¼é€™æ¨£çš„è¼¸å‡ºï¼š
# ==========================================
# ğŸš€ Starting development mode...
# 
# ğŸ“¦ Deploying database...
# âœ… Database deployed successfully
# 
# ğŸ”„ Deploying migration...  
# âœ… Migration completed successfully
# 
# ğŸ“± Deploying app...
# âœ… App deployed successfully
# 
# ğŸ”Œ Port forwarding:
#    - postgres: localhost:5432 -> pod:5432
#    - app: localhost:3000 -> pod:3000
# 
# ğŸ“ File sync active:
#    - ./app -> /app (in container)
# 
# ğŸ“Š Streaming logs...
# ==========================================
```

```bash
# ğŸ¯ å¸¸ç”¨é–‹ç™¼æŒ‡ä»¤ï¼ˆé¡ä¼¼ Docker Compose æŒ‡ä»¤ï¼‰

# æŸ¥çœ‹è³‡æ–™åº«ï¼ˆé¡ä¼¼ docker-compose exec postgres psqlï¼‰
devspace run db

# é‡æ–°åŸ·è¡Œ Migrationï¼ˆé¡ä¼¼ docker-compose restart flywayï¼‰
devspace run migrate

# æŸ¥çœ‹ Migration ç‹€æ…‹
devspace run migration-status

# æŸ¥çœ‹æ‰€æœ‰æœå‹™ç‹€æ…‹ï¼ˆé¡ä¼¼ docker-compose psï¼‰
devspace run status

# é‡ç½®è³‡æ–™åº«ï¼ˆé–‹ç™¼ç”¨ï¼‰
devspace run reset-db

# æŸ¥çœ‹å³æ™‚æ—¥èªŒï¼ˆé¡ä¼¼ docker-compose logs -fï¼‰
devspace logs -f

# åœæ­¢é–‹ç™¼ç’°å¢ƒï¼ˆé¡ä¼¼ docker-compose downï¼‰
devspace purge
```





Migration é–‹ç™¼å·¥ä½œæµç¨‹
```mermaid
graph TD
    START[é–‹å§‹é–‹ç™¼] --> DEV[devspace dev]
    DEV --> DB[è³‡æ–™åº«è‡ªå‹•å•Ÿå‹•]
    DB --> INIT[åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬]
    INIT --> MIGRATION[åŸ·è¡Œ Flyway Migration]
    MIGRATION --> APP[æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•]
    APP --> READY[é–‹ç™¼ç’°å¢ƒå°±ç·’]
    
    READY --> NEWMIG[æ–°å¢ Migration æª”æ¡ˆ]
    NEWMIG --> RUNMIG[devspace run migrate]
    RUNMIG --> TEST[æ¸¬è©¦æ–°åŠŸèƒ½]
    TEST --> READY
    
    READY --> RESET[éœ€è¦é‡ç½®è³‡æ–™åº«ï¼Ÿ]
    RESET --> RESETDB[devspace run reset-db]
    RESETDB --> DB
    
    READY --> STOP[é–‹ç™¼å®Œæˆ]
    STOP --> PURGE[devspace purge]
    
    style START fill:#c8e6c9
    style READY fill:#e3f2fd
    style NEWMIG fill:#fff3e0
    style RESET fill:#ffcdd2
    style STOP fill:#f3e5f5
```

ğŸ§ª æ­¥é©Ÿäº”ï¼šå¯¦éš›æ¸¬è©¦ Migration åŠŸèƒ½
æ–°å¢ä¸€å€‹ Migration
è®“æˆ‘å€‘å¯¦éš›æ¼”ç¤ºå¦‚ä½•åœ¨é–‹ç™¼éç¨‹ä¸­æ–°å¢ Migrationï¼š

```sql
-- database/migrations/V4__Add_comments_table.sql
-- ğŸ¯ æ–°å¢ç•™è¨€åŠŸèƒ½

CREATE TABLE comments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    parent_comment_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    is_approved BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_comments_post_id ON comments(post_id);
CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_comment_id);
CREATE INDEX idx_comments_approved ON comments(is_approved);

-- æ’å…¥ç¯„ä¾‹ç•™è¨€
INSERT INTO comments (post_id, user_id, content, is_approved)
SELECT 
    p.id,
    u.id,
    'Great post! Thanks for sharing.',
    true
FROM posts p
CROSS JOIN users u 
WHERE p.slug = 'welcome-to-our-platform' 
  AND u.username = 'developer'
LIMIT 1;
```

**å¯¦éš›æ“ä½œæµç¨‹**ï¼š
```bash
# 1. ğŸ¯ å»ºç«‹æ–°çš„ Migration æª”æ¡ˆ
echo "å»ºç«‹ V4__Add_comments_table.sql..."

# 2. ğŸ”„ æ›´æ–° ConfigMapï¼ˆåœ¨å¯¦éš›å°ˆæ¡ˆä¸­ï¼Œä½ å¯èƒ½æœƒç”¨ Kustomize æˆ– Helmï¼‰
# ç·¨è¼¯ k8s/migration/configmap.yamlï¼ŒåŠ å…¥æ–°çš„ Migration

# 3. ğŸš€ åŸ·è¡Œ Migration
devspace run migrate

# ä½ æœƒçœ‹åˆ°ï¼š
# ğŸ”„ é‡æ–°åŸ·è¡Œ Migration...
# job.batch "flyway-migration" deleted
# job.batch/flyway-migration created
# job.batch/flyway-migration condition met
# 
# ğŸ“Š Migration ç‹€æ…‹ï¼ˆåŸ·è¡Œå‰ï¼‰ï¼š
# +---------+---------+---------------------+------+---------------------+---------+
# | Version | Description | Type            | State| Installed On        | Undoable|
# +---------+---------+---------------------+------+---------------------+---------+
# | 1       | Create users table | SQL   | Success | 2024-01-15 10:30:00 | No      |
# | 2       | Create posts table | SQL   | Success | 2024-01-15 10:30:05 | No      |
# | 3       | Add user profiles  | SQL   | Success | 2024-01-15 10:30:10 | No      |
# +---------+---------+---------------------+------+---------------------+---------+
# 
# ğŸš€ é–‹å§‹ Flyway Migration...
# Migrating schema "app" to version "4 - Add comments table"
# Successfully applied 1 migration to schema "app"
# 
# ğŸ“Š Migration ç‹€æ…‹ï¼ˆåŸ·è¡Œå¾Œï¼‰ï¼š
# +---------+---------+---------------------+------+---------------------+---------+
# | Version | Description | Type            | State| Installed On        | Undoable|
# +---------+---------+---------------------+------+---------------------+---------+
# | 1       | Create users table | SQL   | Success | 2024-01-15 10:30:00 | No      |
# | 2       | Create posts table | SQL   | Success | 2024-01-15 10:30:05 | No      |
# | 3       | Add user profiles  | SQL   | Success | 2024-01-15 10:30:10 | No      |
# | 4       | Add comments table | SQL   | Success | 2024-01-15 10:35:15 | No      |
# +---------+---------+---------------------+------+---------------------+---------+
# 
# âœ… Flyway Migration å®Œæˆï¼

# 4. ğŸ” é©—è­‰æ–°è¡¨æ ¼
devspace run db
# åœ¨ psql ä¸­åŸ·è¡Œï¼š
# \dt app.*
# SELECT * FROM app.comments;

# 5. ğŸ“Š æŸ¥çœ‹ Migration æ­·å²
devspace run migration-status
```

é–‹ç™¼ä¸­çš„å¸¸è¦‹æƒ…å¢ƒ
## ğŸ¯ æƒ…å¢ƒä¸€ï¼šMigration åŸ·è¡Œå¤±æ•—

```bash
# å¦‚æœ Migration å¤±æ•—ï¼Œä½ æœƒçœ‹åˆ°ï¼š
# âŒ Migration failed: Syntax error at line 15

# è§£æ±ºæ­¥é©Ÿï¼š
# 1. æª¢æŸ¥ Migration æ—¥èªŒ
kubectl logs job/flyway-migration

# 2. ä¿®æ­£ Migration æª”æ¡ˆ
# ç·¨è¼¯ database/migrations/V4__Add_comments_table.sql

# 3. æ›´æ–° ConfigMap
kubectl apply -f k8s/migration/configmap.yaml

# 4. é‡æ–°åŸ·è¡Œ Migration
devspace run migrate
```

## ğŸ¯ æƒ…å¢ƒäºŒï¼šéœ€è¦å›æ»¾è³‡æ–™åº«

```bash
# Flyway ä¸æ”¯æ´è‡ªå‹•å›æ»¾ï¼Œä½†æˆ‘å€‘å¯ä»¥é‡ç½®è³‡æ–™åº«
devspace run reset-db

# æˆ–è€…æ‰‹å‹•å»ºç«‹å›æ»¾è…³æœ¬
# database/migrations/V5__Rollback_comments.sql
```

## ğŸ¯ æƒ…å¢ƒä¸‰ï¼šå¤šäººå”ä½œ Migration è¡çª

```bash
# ç•¶å¤šå€‹é–‹ç™¼è€…åŒæ™‚æ–°å¢ Migration æ™‚ï¼š
# Developer A: V4__Add_comments.sql
# Developer B: V4__Add_tags.sql  â† è¡çªï¼

# è§£æ±ºæ–¹æ¡ˆï¼š
# 1. é‡æ–°å‘½åå…¶ä¸­ä¸€å€‹ç‚º V5
# 2. æˆ–ä½¿ç”¨æ™‚é–“æˆ³ç‰ˆæœ¬è™Ÿï¼šV20240115103000__Add_tags.sql

# 3. é‡æ–°åŒæ­¥
devspace run migrate
```

## ğŸ¯ æƒ…å¢ƒå››ï¼šæ¸¬è©¦è³‡æ–™ç®¡ç†

```bash
# å»ºç«‹æ¸¬è©¦è³‡æ–™è…³æœ¬
# database/migrations/V999__Test_data.sqlï¼ˆé–‹ç™¼ç’°å¢ƒå°ˆç”¨ï¼‰

CREATE OR REPLACE FUNCTION insert_test_data() RETURNS void AS $$
BEGIN
    -- åªåœ¨é–‹ç™¼ç’°å¢ƒåŸ·è¡Œ
    IF current_setting('server_version_num')::int >= 140000 THEN
        -- æ’å…¥å¤§é‡æ¸¬è©¦è³‡æ–™
        INSERT INTO posts (user_id, title, content, slug, status, published_at)
        SELECT 
            (SELECT id FROM users ORDER BY random() LIMIT 1),
            'Test Post ' || generate_series,
            'This is test content for post ' || generate_series,
            'test-post-' || generate_series,
            'published',
            CURRENT_TIMESTAMP - (generate_series || ' days')::interval
        FROM generate_series(1, 100);
    END IF;
END;
$$ LANGUAGE plpgsql;

SELECT insert_test_data();
```

ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹ç¸½çµ
DevSpace vs Docker Compose å°æ¯”
| åŠŸèƒ½ | Docker Compose | DevSpace + K8s | èªªæ˜ |
|------|----------------|----------------|------|
| **ğŸš€ ä¸€éµå•Ÿå‹•** | `docker-compose up` | `devspace dev` | éƒ½èƒ½ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™ |
| **ğŸ”— ä¾è³´ç®¡ç†** | `depends_on` | `dependsOn` | è‡ªå‹•ç®¡ç†æœå‹™å•Ÿå‹•é †åº |
| **ğŸ“ æª”æ¡ˆåŒæ­¥** | `volumes: - .:/app` | `sync` é…ç½® | æ”¯æ´ç†±é‡è¼‰é–‹ç™¼ |
| **ğŸ”Œ ç«¯å£è½‰ç™¼** | `ports: - "3000:3000"` | `ports` é…ç½® | è‡ªå‹•ç«¯å£è½‰ç™¼ |
| **ğŸ“Š æ—¥èªŒæŸ¥çœ‹** | `docker-compose logs -f` | `devspace logs -f` | çµ±ä¸€æ—¥èªŒæŸ¥çœ‹ |
| **ğŸ—„ï¸ è³‡æ–™åº«é€£ç·š** | `docker-compose exec db psql` | `devspace run db` | å¿«é€Ÿè³‡æ–™åº«å­˜å– |
| **ğŸ”„ Migration** | æ‰‹å‹•é‡å•Ÿæœå‹™ | `devspace run migrate` | æ›´éˆæ´»çš„ Migration ç®¡ç† |
| **ğŸ› ï¸ é™¤éŒ¯èƒ½åŠ›** | åŸºæœ¬ | æ›´å¼·å¤§ | K8s æä¾›æ›´å¤šç›£æ§å’Œé™¤éŒ¯å·¥å…· |
| **ğŸ­ ç”Ÿç”¢å°±ç·’** | éœ€è¦é¡å¤–é…ç½® | åŸç”Ÿæ”¯æ´ | é–‹ç™¼ç’°å¢ƒç›´æ¥å°æ‡‰ç”Ÿç”¢ç’°å¢ƒ |
| **ğŸ“ˆ æ“´å±•æ€§** | æœ‰é™ | ç„¡é™ | K8s æä¾›æ›´å¥½çš„æ“´å±•èƒ½åŠ› |

æœ€ä½³å¯¦è¸å»ºè­°

## ğŸ¯ Migration æœ€ä½³å¯¦è¸

### âœ… å»ºè­°åšæ³•
```sql
-- âœ… ä½¿ç”¨æè¿°æ€§çš„æª”æ¡ˆåç¨±
V1__Create_users_table.sql
V2__Add_user_email_index.sql
V3__Update_user_schema_for_oauth.sql

-- âœ… ç¸½æ˜¯åŒ…å« IF EXISTS æª¢æŸ¥
CREATE TABLE IF NOT EXISTS users (...);
ALTER TABLE users ADD COLUMN IF NOT EXISTS email_verified BOOLEAN DEFAULT false;

-- âœ… ä½¿ç”¨äº¤æ˜“ï¼ˆFlyway æœƒè‡ªå‹•åŒ…è£ï¼Œä½†æ˜ç¢ºæ›´å¥½ï¼‰
BEGIN;
-- your migration code
COMMIT;

-- âœ… åŒ…å«å›æ»¾èªªæ˜
-- Rollback: DROP TABLE comments;
CREATE TABLE comments (...);
```

### âŒ é¿å…çš„åšæ³•
```sql
-- âŒ ä¸è¦ç›´æ¥åˆªé™¤è³‡æ–™
DROP TABLE old_table;  -- å±éšªï¼

-- âŒ ä¸è¦ä½¿ç”¨æ¨¡ç³Šçš„ç‰ˆæœ¬è™Ÿ
V1.sql, V2.sql  -- ä¸å¤ æè¿°æ€§

-- âŒ ä¸è¦åœ¨ Migration ä¸­ä½¿ç”¨ç’°å¢ƒç‰¹å®šçš„è³‡æ–™
INSERT INTO users VALUES ('specific-prod-user', ...);  -- æ‡‰è©²åˆ†é›¢
```

## ğŸ› ï¸ DevSpace æœ€ä½³å¯¦è¸

### âœ… å»ºè­°é…ç½®
```yaml
# âœ… ä½¿ç”¨æ˜ç¢ºçš„ä¾è³´é—œä¿‚
deployments:
  database:
    kubectl:
      manifests: [...]
  migration:
    dependsOn: [database]  # æ˜ç¢ºä¾è³´
  app:
    dependsOn: [migration]  # ç¢ºä¿ Migration å®Œæˆ

# âœ… é…ç½®é©ç•¶çš„è³‡æºé™åˆ¶
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# âœ… ä½¿ç”¨å¥åº·æª¢æŸ¥
livenessProbe:
  httpGet:
    path: /health
    port: 3000
```

# ğŸ§  ç¸½çµ Mind Map
```mermaid
mindmap
  root((Day 11<br/>DevSpace + Flyway<br/>æœ¬åœ°é–‹ç™¼å¯¦è¸))
    ğŸ¯ å­¸ç¿’ç›®æ¨™
      å¾ Docker Compose è½‰æ›åˆ° K8s
      ç°¡åŒ–æœ¬åœ°é–‹ç™¼æµç¨‹
      è‡ªå‹•åŒ– Migration ç®¡ç†
      å»ºç«‹å®Œæ•´é–‹ç™¼å·¥ä½œæµ
    
    ğŸ³ Docker Compose å›é¡§
      ä¸€éµå•Ÿå‹• `docker-compose up`
      è‡ªå‹•ä¾è³´ç®¡ç† `depends_on`
      ç°¡å–®æª”æ¡ˆæ›è¼‰ `volumes`
      çµ±ä¸€æ—¥èªŒæŸ¥çœ‹ `logs -f`
      
    â˜¸ï¸ Kubernetes æŒ‘æˆ°
      å¤šå€‹ YAML æª”æ¡ˆ
      è¤‡é›œä¾è³´é—œä¿‚
      æ‰‹å‹•ç«¯å£è½‰ç™¼
      åˆ†æ•£çš„æ—¥èªŒæŸ¥çœ‹
      
    ğŸš€ DevSpace è§£æ±ºæ–¹æ¡ˆ
      devspace.yaml é…ç½®
        é¡ä¼¼ docker-compose.yml
        deployments å®šç¾©æœå‹™
        dependsOn ç®¡ç†ä¾è³´
        ports è‡ªå‹•è½‰ç™¼
        sync ç†±é‡è¼‰
      ä¸€éµé–‹ç™¼ `devspace dev`
      è‡ªè¨‚æŒ‡ä»¤ `devspace run`
      
    ğŸ—„ï¸ è³‡æ–™åº«è¨­å®š
      StatefulSet é…ç½®
      ConfigMap åˆå§‹åŒ–è…³æœ¬
      Secret æ•æ„Ÿè³‡æ–™ç®¡ç†
      æŒä¹…åŒ–å„²å­˜
      
    ğŸ”„ Flyway Migration
      Migration è…³æœ¬ç®¡ç†
        V1__Create_users_table.sql
        V2__Create_posts_table.sql
        ç‰ˆæœ¬åŒ– Schema è®Šæ›´
      Job é…ç½®
        ç­‰å¾…è³‡æ–™åº«å°±ç·’
        è‡ªå‹•åŸ·è¡Œ Migration
        ç‹€æ…‹å›å ±
      é–‹ç™¼å·¥ä½œæµ
        æ–°å¢ Migration
        æ¸¬è©¦åŸ·è¡Œ
        ç‹€æ…‹æª¢æŸ¥
        
    ğŸ› ï¸ å¯¦éš›æ“ä½œ
      å®‰è£ DevSpace
      å°ˆæ¡ˆçµæ§‹è¨­è¨ˆ
      é…ç½®æª”æ¡ˆæ’°å¯«
      ä¸€éµå•Ÿå‹•æ¸¬è©¦
      Migration å¯¦é©—
      
    ğŸ“Š æœ€ä½³å¯¦è¸
      Migration è¨­è¨ˆåŸå‰‡
        æè¿°æ€§æª”æ¡ˆåç¨±
        åŒ…å«å›æ»¾èªªæ˜
        é¿å…ç ´å£æ€§è®Šæ›´
      åœ˜éšŠå”ä½œ
        çµ±ä¸€é–‹ç™¼ç’°å¢ƒ
        ç‰ˆæœ¬æ§åˆ¶æ•´åˆ
        CI/CD æ•´åˆ
        
    ğŸ‰ å­¸ç¿’æˆæœ
      åƒ Docker Compose ä¸€æ¨£ç°¡å–®
      æ›´å¼·å¤§çš„ K8s åŠŸèƒ½
      è‡ªå‹•åŒ– Migration ç®¡ç†
      å®Œæ•´çš„é–‹ç™¼å·¥ä½œæµ
```

### ğŸ¯ åœ˜éšŠå”ä½œå»ºè­°
```bash
# âœ… å»ºç«‹åœ˜éšŠè…³æœ¬
# scripts/team-setup.sh
#!/bin/bash
echo "ğŸš€ è¨­å®šåœ˜éšŠé–‹ç™¼ç’°å¢ƒ..."

# æª¢æŸ¥å¿…è¦å·¥å…·
command -v devspace >/dev/null 2>&1 || { echo "è«‹å®‰è£ DevSpace"; exit 1; }
command -v kubectl >/dev/null 2>&1 || { echo "è«‹å®‰è£ kubectl"; exit 1; }

# è¨­å®š K8s context
echo "é¸æ“‡ Kubernetes context:"
kubectl config get-contexts

# å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
devspace dev
```



# ç¸½çµ
âœ… è§£æ±ºäº†ä»€éº¼å•é¡Œ 
ğŸ³ â†’ â˜¸ï¸ å¹³æ»‘è½‰æ›ï¼šå¾ Docker Compose çš„ç°¡å–®é«”é©—è½‰æ›åˆ° Kubernetes çš„å¼·å¤§åŠŸèƒ½
ğŸ”„ è‡ªå‹•åŒ– Migrationï¼šä¸å†éœ€è¦æ‰‹å‹•åŸ·è¡Œè³‡æ–™åº« Migration
ğŸš€ ä¸€éµé–‹ç™¼ç’°å¢ƒï¼šdevspace dev å°±åƒ docker-compose up ä¸€æ¨£ç°¡å–®
ğŸ“Š çµ±ä¸€ç®¡ç†ï¼šè³‡æ–™åº«ã€Migrationã€æ‡‰ç”¨ç¨‹å¼çš„å®Œæ•´ç”Ÿå‘½é€±æœŸç®¡ç†
ğŸ¯ æ ¸å¿ƒæŠ€èƒ½ç²å¾—
DevSpace é…ç½®ï¼šå­¸æœƒå¯« devspace.yaml ä¾†ç®¡ç†è¤‡é›œçš„ K8s ç’°å¢ƒ
Flyway Integrationï¼šæŒæ¡åœ¨ K8s ä¸­è‡ªå‹•åŒ–åŸ·è¡Œè³‡æ–™åº« Migration
ä¾è³´ç®¡ç†ï¼šç†è§£å¦‚ä½•åœ¨ K8s ä¸­ç®¡ç†æœå‹™å•Ÿå‹•é †åº
é–‹ç™¼å·¥ä½œæµï¼šå»ºç«‹äº†å®Œæ•´çš„æœ¬åœ°é–‹ç™¼åˆ°æ¸¬è©¦çš„æµç¨‹


```mermaid
graph LR
    DEV[é–‹ç™¼è€…] --> DS[DevSpace CLI]
    DS --> K8S[Kubernetes Cluster]
    DS --> SYNC[æ–‡ä»¶åŒæ­¥]
    DS --> PF[ç«¯å£è½‰ç™¼]
    DS --> LOGS[æ—¥èªŒèšåˆ]
    
    style DS fill:#e3f2fd
    style SYNC fill:#c8e6c9
    style PF fill:#fff3e0
    style LOGS fill:#f3e5f5
```
